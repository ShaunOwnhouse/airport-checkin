<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seat Selection - O.R. Tambo Airport</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }
        
        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .flight-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .flight-info p {
            margin: 5px 0;
            color: #555;
            font-size: 16px;
        }
        
        .plane {
            background: #f0f0f0;
            border-radius: 20px;
            padding: 40px 30px;
            position: relative;
        }
        
        .cockpit {
            width: 120px;
            height: 100px;
            background: #667eea;
            margin: 0 auto 40px;
            border-radius: 50% 50% 0 0;
            position: relative;
        }
        
        .cockpit::after {
            content: '‚úà';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: white;
        }
        
        .section-label {
            text-align: center;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0 20px;
            font-size: 20px;
        }
        
        .row {
            display: flex;
            justify-content: center;
            margin: 10px 0;
            gap: 12px;
            position: relative;
        }
        
        .row.emergency-exit {
            border: 2px solid #f44336;
            border-radius: 5px;
            padding: 8px;
            margin: 20px 0;
            background: #ffebee;
        }
        
        .exit-label {
            position: absolute;
            left: -90px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #f44336;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .exit-label::before {
            content: 'üö™';
            font-size: 18px;
        }
        
        .row-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            font-weight: bold;
            color: #666;
            font-size: 16px;
        }
        
        .seats-left, .seats-right {
            display: flex;
            gap: 10px;
        }
        
        .aisle {
            width: 50px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .aisle::after {
            content: 'AISLE';
            font-size: 10px;
            color: #999;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 2px;
        }
        
        .seat {
            width: 55px;
            height: 55px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #4CAF50;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .seat.window::before {
            content: 'ü™ü';
            position: absolute;
            top: -20px;
            font-size: 16px;
        }
        
        .seat:hover:not(.occupied):not(.selected) {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .seat.occupied {
            background: #ccc;
            cursor: not-allowed;
            color: #666;
        }
        
        .seat.selected {
            background: #2196F3;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.5);
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 30px 0 20px;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .legend-box {
            width: 35px;
            height: 35px;
            border-radius: 5px;
        }
        
        .selected-info {
            background: #e3f2fd;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
        }
        
        .selected-info h3 {
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .selected-info p {
            font-size: 20px;
            color: #333;
            margin: 5px 0;
        }
        
        .btn-confirm {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }
        
        .btn-confirm:hover {
            background: #45a049;
        }
        
        .btn-confirm:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .success-message {
            display: none;
            background: #4CAF50;
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-size: 18px;
            line-height: 1.6;
        }
        
        .error-message {
            display: none;
            background: #f44336;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è Select Your Seat</h1>
            <div class="flight-info">
                <p><strong>Flight:</strong> <span id="flightNumber">-</span></p>
                <p><strong>Route:</strong> <span id="route">-</span></p>
                <p><strong>Passenger:</strong> <span id="passengerName">-</span></p>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-box" style="background: #4CAF50;"></div>
                <span>Available</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #ccc;"></div>
                <span>Occupied</span>
            </div>
            <div class="legend-item">
                <div class="legend-box" style="background: #2196F3;"></div>
                <span>Selected</span>
            </div>
            <div class="legend-item">
                <span>ü™ü = Window</span>
            </div>
            <div class="legend-item">
                <span>üö™ = Emergency Exit</span>
            </div>
        </div>
        
        <div class="plane">
            <div class="cockpit"></div>
            <div class="section-label">ECONOMY CLASS</div>
            <div id="economyClass"></div>
        </div>
        
        <div class="selected-info" id="selectedInfo" style="display: none;">
            <h3>Selected Seat</h3>
            <p id="selectedSeat">-</p>
            <p id="seatType" style="font-size: 16px; color: #666;"></p>
            <button class="btn-confirm" id="confirmBtn" onclick="confirmSelection()">
                Confirm Seat Selection
            </button>
        </div>
        
        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const passenger = urlParams.get('passenger') || 'Passenger';
        const flight = urlParams.get('flight') || 'Flight';
        const route = urlParams.get('route') || 'Route';
        const booking = urlParams.get('booking') || '';
        
        document.getElementById('flightNumber').textContent = flight;
        document.getElementById('route').textContent = route;
        document.getElementById('passengerName').textContent = passenger;
        
        let selectedSeat = null;
        let selectedSeatType = '';
        
        const economyRows = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25];
        const emergencyExitRows = [12, 13];
        const occupiedSeats = ['1A', '1F', '2C', '2D', '4A', '4F', '5B', '5E', '7A', '7F', '10C', '10D', '12A', '15F', '18B'];
        
        const economyContainer = document.getElementById('economyClass');
        economyRows.forEach(rowNum => {
            const row = document.createElement('div');
            row.className = 'row';
            
            if (emergencyExitRows.includes(rowNum)) {
                row.classList.add('emergency-exit');
                const exitLabel = document.createElement('div');
                exitLabel.className = 'exit-label';
                exitLabel.textContent = 'EXIT';
                row.appendChild(exitLabel);
            }
            
            const rowLabel = document.createElement('div');
            rowLabel.className = 'row-number';
            rowLabel.textContent = rowNum;
            row.appendChild(rowLabel);
            
            const seatsLeft = document.createElement('div');
            seatsLeft.className = 'seats-left';
            ['A', 'B', 'C'].forEach((letter, index) => {
                const seat = createSeat(rowNum, letter, index === 0, emergencyExitRows.includes(rowNum));
                seatsLeft.appendChild(seat);
            });
            row.appendChild(seatsLeft);
            
            const aisle = document.createElement('div');
            aisle.className = 'aisle';
            row.appendChild(aisle);
            
            const seatsRight = document.createElement('div');
            seatsRight.className = 'seats-right';
            ['D', 'E', 'F'].forEach((letter, index) => {
                const seat = createSeat(rowNum, letter, index === 2, emergencyExitRows.includes(rowNum));
                seatsRight.appendChild(seat);
            });
            row.appendChild(seatsRight);
            
            economyContainer.appendChild(row);
        });
        
        function createSeat(row, letter, isWindow, isEmergencyExit) {
            const seat = document.createElement('div');
            const seatId = row + letter;
            seat.className = 'seat';
            
            if (isWindow) {
                seat.classList.add('window');
            }
            
            seat.textContent = seatId;
            
            if (occupiedSeats.includes(seatId)) {
                seat.classList.add('occupied');
            } else {
                seat.onclick = () => selectSeat(seatId, seat, isWindow, isEmergencyExit);
            }
            
            return seat;
        }
        
        function selectSeat(seatId, seatElement, isWindow, isEmergencyExit) {
            document.querySelectorAll('.seat.selected').forEach(s => {
                s.classList.remove('selected');
            });
            
            seatElement.classList.add('selected');
            selectedSeat = seatId;
            
            let seatTypeDesc = [];
            if (isWindow) seatTypeDesc.push('Window Seat');
            if (!isWindow && (seatId.includes('B') || seatId.includes('E'))) seatTypeDesc.push('Aisle Seat');
            if (!isWindow && (seatId.includes('C') || seatId.includes('D'))) seatTypeDesc.push('Middle Seat');
            if (isEmergencyExit) seatTypeDesc.push('Emergency Exit Row (Extra Legroom)');
            
            selectedSeatType = seatTypeDesc.join(' ‚Ä¢ ');
            
            const selectedInfo = document.getElementById('selectedInfo');
            selectedInfo.style.display = 'block';
            document.getElementById('selectedSeat').textContent = 'Seat ' + seatId;
            document.getElementById('seatType').textContent = selectedSeatType;
            
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
        }
        
        function confirmSelection() {
            if (!selectedSeat) {
                alert('Please select a seat first');
                return;
            }
            
            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Confirming...';
            
            document.getElementById('selectedInfo').style.display = 'none';
            const successMsg = document.getElementById('successMessage');
            successMsg.innerHTML = '‚è≥ Confirming seat ' + selectedSeat + '...';
            successMsg.style.display = 'block';
            
            updateMockAPI(booking, selectedSeat);
        }
        
        function updateMockAPI(bookingRef, seat) {
            const mockApiUrl = 'https://691d87c7d58e64bf0d36832c.mockapi.io/FlightDetails';
            
            console.log('Attempting to update MockAPI...');
            console.log('Booking Reference:', bookingRef);
            console.log('Selected Seat:', seat);
            
            // STEP 1: Fetch all passengers
            fetch(mockApiUrl)
                .then(response => {
                    console.log('Fetch response status:', response.status);
                    return response.json();
                })
                .then(allPassengers => {
                    console.log('All passengers:', allPassengers);
                    
                    // STEP 2: Find passenger with matching booking reference
                    const passenger = allPassengers.find(p => p.bookingReference === bookingRef);
                    
                    if (passenger) {
                        console.log('Found passenger:', passenger);
                        const passengerId = passenger.id;
                        
                        // STEP 3: Prepare updated data
                        const updatedData = {
                            bookingReference: passenger.bookingReference,
                            firstName: passenger.firstName,
                            lastName: passenger.lastName,
                            title: passenger.title,
                            idNumber: passenger.idNumber,
                            email: passenger.email,
                            phone: passenger.phone,
                            flightNumber: passenger.flightNumber,
                            airline: passenger.airline,
                            origin: passenger.origin,
                            destination: passenger.destination,
                            originName: passenger.originName,
                            destinationName: passenger.destinationName,
                            departureDate: passenger.departureDate,
                            departureTime: passenger.departureTime,
                            arrivalTime: passenger.arrivalTime,
                            terminal: passenger.terminal,
                            gate: passenger.gate,
                            bookingClass: passenger.bookingClass,
                            seatNumber: seat,
                            checkedIn: true,
                            boardingPassNumber: passenger.boardingPassNumber,
                            checkinTime: new Date().toISOString(),
                            baggageAllowance: passenger.baggageAllowance,
                            status: passenger.status
                        };
                        
                        console.log('Updating with data:', updatedData);
                        
                        // STEP 4: Update the passenger
                        return fetch(mockApiUrl + '/' + passengerId, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(updatedData)
                        });
                    } else {
                        throw new Error('Passenger not found with booking reference: ' + bookingRef);
                    }
                })
                .then(response => {
                    console.log('Update response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Update successful:', data);
                    const successMsg = document.getElementById('successMessage');
                    successMsg.innerHTML = '‚úÖ Seat ' + seat + ' confirmed!<br><br>' +
                                          'üì± Return to the chat and type <strong>"done"</strong> to continue.';
                    successMsg.style.display = 'block';
                    
                    setTimeout(() => {
                        window.close();
                    }, 5000);
                })
                .catch(error => {
                    console.error('Error details:', error);
                    const errorMsg = document.getElementById('errorMessage');
                    errorMsg.innerHTML = '‚ùå Could not confirm seat with system.<br>Please return to chat and type: <strong>done ' + seat + '</strong>';
                    errorMsg.style.display = 'block';
                    document.getElementById('successMessage').style.display = 'none';
                    
                    const confirmBtn = document.getElementById('confirmBtn');
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Confirm Seat Selection';
                });
        }
    </script>
</body>
</html>
