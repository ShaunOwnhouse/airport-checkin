<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seat Selection - O.R. Tambo Airport</title>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #667eea;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .flight-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .flight-info p { margin: 5px 0; font-size: 16px; color: #555; }

        .plane {
            background: #f0f0f0;
            border-radius: 20px;
            padding: 40px 30px;
        }

        .cockpit {
            width: 120px;
            height: 100px;
            background: #667eea;
            margin: 0 auto 40px;
            border-radius: 50% 50% 0 0;
            position: relative;
        }
        .cockpit::after {
            content: '‚úà';
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            color: white;
        }

        .section-label {
            text-align: center;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            font-size: 20px;
        }

        .row {
            display: flex;
            justify-content: center;
            margin: 10px 0;
            gap: 12px;
            position: relative;
        }

        .row.emergency-exit {
            border: 2px solid #f44336;
            background: #ffebee;
            border-radius: 5px;
            padding: 8px;
        }

        .exit-label {
            position: absolute;
            left: -90px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #f44336;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .row-number {
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #666;
            font-weight: bold;
        }

        .seats-left, .seats-right { display: flex; gap: 10px; }
        .aisle {
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .aisle::after {
            content: 'AISLE';
            font-size: 10px;
            color: #999;
            writing-mode: vertical-rl;
        }

        .seat {
            width: 55px;
            height: 55px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: #4CAF50;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            font-weight: bold;
            transition: 0.3s;
            position: relative;
        }

        .seat.window::before {
            content: 'ü™ü';
            position: absolute;
            top: -20px;
            font-size: 16px;
        }

        .seat:hover:not(.occupied):not(.selected) {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .seat.occupied {
            background: #ccc;
            cursor: not-allowed;
            color: #666;
        }

        .seat.selected {
            background: #2196F3;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(33,150,243,0.5);
        }

        .legend {
            display: flex; justify-content: center;
            gap: 25px; margin: 30px 0;
        }

        .legend-item { display: flex; align-items: center; gap: 8px; }

        .legend-box {
            width: 35px; height: 35px;
            border-radius: 5px;
        }

        .selected-info {
            background: #e3f2fd;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
            text-align: center;
            display: none;
        }

        .btn-confirm {
            background: #4CAF50; color: white;
            border: none;
            padding: 18px 50px;
            font-size: 20px;
            border-radius: 8px;
            cursor: pointer;
        }

        .success-message, .error-message {
            margin-top: 20px;
            padding: 20px;
            display: none;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
        }
        .success-message { background: #4CAF50; color: white; }
        .error-message { background: #f44336; color: white; }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>‚úàÔ∏è Select Your Seat</h1>

            <div class="flight-info">
                <p><strong>Flight:</strong> <span id="flightNumber">-</span></p>
                <p><strong>Route:</strong> <span id="route">-</span></p>
                <p><strong>Passenger:</strong> <span id="passengerName">-</span></p>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-box" style="background:#4CAF50"></div>Available</div>
            <div class="legend-item"><div class="legend-box" style="background:#ccc"></div>Occupied</div>
            <div class="legend-item"><div class="legend-box" style="background:#2196F3"></div>Selected</div>
            <div class="legend-item">ü™ü Window</div>
            <div class="legend-item">üö™ Emergency Exit</div>
        </div>

        <div class="plane">
            <div class="cockpit"></div>
            <div class="section-label">ECONOMY CLASS</div>
            <div id="economyClass"></div>
        </div>

        <div class="selected-info" id="selectedInfo">
            <h3>Selected Seat</h3>
            <p id="selectedSeat">-</p>
            <p id="seatType" style="font-size:14px;color:#666;"></p>
            <button class="btn-confirm" onclick="confirmSelection()">Confirm Seat Selection</button>
        </div>

        <div class="success-message" id="successMessage"></div>
        <div class="error-message" id="errorMessage"></div>
    </div>

<script>
    // üîπ Read URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const passenger = urlParams.get('passenger') || 'Passenger';
    const flight = urlParams.get('flight') || 'Flight';
    const route = urlParams.get('route') || '-';
    const booking = urlParams.get('booking') || '';

    document.getElementById('passengerName').textContent = passenger;
    document.getElementById('flightNumber').textContent = flight;
    document.getElementById('route').textContent = route;

    let selectedSeat = null;
    let selectedSeatType = '';

    const economyRows = [...Array(25).keys()].map(i => i + 1);
    const emergencyExitRows = [12, 13];

    const occupiedSeats = ["2C", "4A", "5B", "7A"]; // You may dynamically load these later

    const economyContainer = document.getElementById('economyClass');

    // üîπ Build seat map
    economyRows.forEach(rowNum => {
        const row = document.createElement('div');
        row.className = 'row';

        if (emergencyExitRows.includes(rowNum)) {
            row.classList.add('emergency-exit');
            const exitLabel = document.createElement('div');
            exitLabel.className = 'exit-label';
            exitLabel.textContent = 'EXIT';
            row.appendChild(exitLabel);
        }

        const rowLabel = document.createElement('div');
        rowLabel.className = 'row-number';
        rowLabel.textContent = rowNum;
        row.appendChild(rowLabel);

        const seatsLeft = document.createElement('div');
        seatsLeft.className = 'seats-left';

        ['A', 'B', 'C'].forEach((letter, idx) => {
            const isWindow = idx === 0;
            const seat = createSeat(rowNum, letter, isWindow, emergencyExitRows.includes(rowNum));
            seatsLeft.appendChild(seat);
        });

        row.appendChild(seatsLeft);

        const aisle = document.createElement('div');
        aisle.className = 'aisle';
        row.appendChild(aisle);

        const seatsRight = document.createElement('div');
        seatsRight.className = 'seats-right';

        ['D', 'E', 'F'].forEach((letter, idx) => {
            const isWindow = idx === 2;
            const seat = createSeat(rowNum, letter, isWindow, emergencyExitRows.includes(rowNum));
            seatsRight.appendChild(seat);
        });

        row.appendChild(seatsRight);
        economyContainer.appendChild(row);
    });

    // üîπ Create individual seat element
    function createSeat(row, letter, isWindow, isEmergencyExit) {
        const seatId = `${row}${letter}`;
        const seat = document.createElement('div');

        seat.className = 'seat';
        seat.textContent = seatId;

        if (isWindow) seat.classList.add('window');
        if (occupiedSeats.includes(seatId)) seat.classList.add('occupied');
        else seat.onclick = () => selectSeat(seatId, seat, isWindow, isEmergencyExit);

        return seat;
    }

    // üîπ Seat clicked
    function selectSeat(seatId, seatElement, isWindow, isEmergencyExit) {
        document.querySelectorAll('.seat.selected').forEach(s => s.classList.remove('selected'));
        seatElement.classList.add('selected');

        selectedSeat = seatId;

        let seatType = [];
        if (isWindow) seatType.push("Window Seat");
        if (!isWindow && (seatId.includes("B") || seatId.includes("E"))) seatType.push("Aisle Seat");
        if (seatId.includes("C") || seatId.includes("D")) seatType.push("Middle Seat");
        if (isEmergencyExit) seatType.push("Emergency Exit (Extra Legroom)");

        selectedSeatType = seatType.join(" ‚Ä¢ ");

        document.getElementById("selectedInfo").style.display = "block";
        document.getElementById("selectedSeat").textContent = "Seat " + seatId;
        document.getElementById("seatType").textContent = selectedSeatType;

        document.getElementById("successMessage").style.display = "none";
        document.getElementById("errorMessage").style.display = "none";
    }

    // üîπ Confirm seat selection
    function confirmSelection() {
        if (!selectedSeat) return alert("Please select a seat first");
        updateMockAPI(booking, selectedSeat);
    }

    // üî• FINAL MOCKAPI UPDATE LOGIC
    function updateMockAPI(bookingRef, seat) {
        const mockApiUrl = "https://691d87c7d58e64bf0d36832c.mockapi.io/FlightDetails";

        fetch(mockApiUrl)
            .then(res => res.json())
            .then(passengers => {

                const passenger = passengers.find(p => p.bookingReference === bookingRef);
                if (!passenger) throw new Error("Passenger not found: " + bookingRef);

                const updated = {
                    ...passenger,
                    seatNumber: seat,
                    checkedIn: true,
                    checkinTime: new Date().toISOString()
                };

                return fetch(`${mockApiUrl}/${passenger.id}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(updated)
                });
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById("successMessage").innerHTML =
                    `‚úÖ Seat <strong>${seat}</strong> confirmed!<br><br>
                     üì± Return to chat and type <b>"done"</b>.`;
                document.getElementById("successMessage").style.display = "block";

                setTimeout(() => window.close(), 5000);
            })
            .catch(err => {
                document.getElementById("errorMessage").innerHTML =
                    `‚ùå Error updating seat.<br>${err.message}`;
                document.getElementById("errorMessage").style.display = "block";
            });
    }
</script>

</body>
</html>
